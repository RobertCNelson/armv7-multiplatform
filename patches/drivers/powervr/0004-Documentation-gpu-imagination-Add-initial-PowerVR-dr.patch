From afa72bcb756a0cb595aa7bd9a657b381c877de49 Mon Sep 17 00:00:00 2001
From: Matt Coster <matt.coster@imgtec.com>
Date: Wed, 1 Sep 2021 15:37:46 +0100
Subject: [PATCH 4/4] Documentation: gpu/imagination: Add initial PowerVR
 driver documentation

Signed-off-by: Matt Coster <matt.coster@imgtec.com>
---
 Documentation/gpu/drivers.rst                 |   2 +
 Documentation/gpu/imagination/index.rst       |  12 ++
 Documentation/gpu/imagination/uapi.rst        | 131 ++++++++++++
 .../gpu/imagination/virtual_memory.rst        | 190 ++++++++++++++++++
 4 files changed, 335 insertions(+)
 create mode 100644 Documentation/gpu/imagination/index.rst
 create mode 100644 Documentation/gpu/imagination/uapi.rst
 create mode 100644 Documentation/gpu/imagination/virtual_memory.rst

diff --git a/Documentation/gpu/drivers.rst b/Documentation/gpu/drivers.rst
index 3a52f48215a3..5487deb218a3 100644
--- a/Documentation/gpu/drivers.rst
+++ b/Documentation/gpu/drivers.rst
@@ -3,9 +3,11 @@ GPU Driver Documentation
 ========================
 
 .. toctree::
+   :maxdepth: 3
 
    amdgpu/index
    i915
+   imagination/index
    mcde
    meson
    pl111
diff --git a/Documentation/gpu/imagination/index.rst b/Documentation/gpu/imagination/index.rst
new file mode 100644
index 000000000000..7f25c8560822
--- /dev/null
+++ b/Documentation/gpu/imagination/index.rst
@@ -0,0 +1,12 @@
+=======================================
+drm/imagination PowerVR Graphics Driver
+=======================================
+
+.. kernel-doc:: drivers/gpu/drm/imagination/pvr_drv.c
+   :doc: PowerVR Graphics Driver
+
+.. toctree::
+   :maxdepth: 3
+
+   uapi
+   virtual_memory
diff --git a/Documentation/gpu/imagination/uapi.rst b/Documentation/gpu/imagination/uapi.rst
new file mode 100644
index 000000000000..5530e8103b64
--- /dev/null
+++ b/Documentation/gpu/imagination/uapi.rst
@@ -0,0 +1,131 @@
+====
+UAPI
+====
+The sources associated with this section can be found in ``pvr_drm.h``.
+
+.. kernel-doc:: include/uapi/drm/pvr_drm.h
+   :doc: PowerVR UAPI
+
+
+IOCTLS
+======
+.. kernel-doc:: include/uapi/drm/pvr_drm.h
+   :doc: IOCTLS
+
+.. kernel-doc:: include/uapi/drm/pvr_drm.h
+   :identifiers: PVR_IOCTL
+
+CREATE_BO
+---------
+.. kernel-doc:: include/uapi/drm/pvr_drm.h
+   :doc: IOCTL CREATE_BO
+
+.. kernel-doc:: include/uapi/drm/pvr_drm.h
+   :identifiers: drm_pvr_ioctl_create_bo_args
+
+.. kernel-doc:: include/uapi/drm/pvr_drm.h
+   :doc: Flags for CREATE_BO
+
+GET_BO_MMAP_OFFSET
+------------------
+.. kernel-doc:: include/uapi/drm/pvr_drm.h
+   :doc: IOCTL GET_BO_MMAP_OFFSET
+
+.. kernel-doc:: include/uapi/drm/pvr_drm.h
+   :identifiers: drm_pvr_ioctl_get_bo_mmap_offset_args
+
+GET_PARAM
+---------
+.. kernel-doc:: include/uapi/drm/pvr_drm.h
+   :doc: IOCTL GET_PARAM
+
+.. kernel-doc:: include/uapi/drm/pvr_drm.h
+   :identifiers: drm_pvr_ioctl_get_param_args
+
+.. kernel-doc:: include/uapi/drm/pvr_drm.h
+   :identifiers: drm_pvr_param
+
+CREATE_CONTEXT
+--------------
+.. kernel-doc:: include/uapi/drm/pvr_drm.h
+   :doc: IOCTL CREATE_CONTEXT
+
+.. kernel-doc:: include/uapi/drm/pvr_drm.h
+   :identifiers: drm_pvr_ioctl_create_context_args
+
+.. kernel-doc:: include/uapi/drm/pvr_drm.h
+   :identifiers: drm_pvr_ctx_priority
+                 drm_pvr_ctx_type
+                 drm_pvr_static_render_context_state
+                 drm_pvr_static_render_context_state_format
+                 drm_pvr_reset_framework
+                 drm_pvr_reset_framework_format
+
+.. kernel-doc:: include/uapi/drm/pvr_drm.h
+   :doc: Flags for CREATE_CONTEXT
+
+DESTROY_CONTEXT
+---------------
+.. kernel-doc:: include/uapi/drm/pvr_drm.h
+   :doc: IOCTL DESTROY_CONTEXT
+
+.. kernel-doc:: include/uapi/drm/pvr_drm.h
+   :identifiers: drm_pvr_ioctl_destroy_context_args
+
+CREATE_OBJECT
+-------------
+.. kernel-doc:: include/uapi/drm/pvr_drm.h
+   :doc: IOCTL CREATE_OBJECT
+
+.. kernel-doc:: include/uapi/drm/pvr_drm.h
+   :identifiers: drm_pvr_ioctl_create_object_args
+
+.. kernel-doc:: include/uapi/drm/pvr_drm.h
+   :identifiers: drm_pvr_object_type
+                 drm_pvr_ioctl_create_free_list_args
+                 create_hwrt_geom_data_args
+                 create_hwrt_rt_data_args
+                 create_hwrt_free_list_args
+                 drm_pvr_ioctl_create_hwrt_dataset_args
+
+DESTROY_OBJECT
+--------------
+.. kernel-doc:: include/uapi/drm/pvr_drm.h
+   :doc: IOCTL DESTROY_OBJECT
+
+.. kernel-doc:: include/uapi/drm/pvr_drm.h
+   :identifiers: drm_pvr_ioctl_destroy_object_args
+
+GET_HEAP_INFO
+-------------
+.. kernel-doc:: include/uapi/drm/pvr_drm.h
+   :doc: IOCTL GET_HEAP_INFO
+
+.. kernel-doc:: include/uapi/drm/pvr_drm.h
+   :identifiers: drm_pvr_ioctl_get_heap_info_args
+
+.. kernel-doc:: include/uapi/drm/pvr_drm.h
+   :identifiers: drm_pvr_heap_id
+
+VM_OP
+-----
+.. kernel-doc:: include/uapi/drm/pvr_drm.h
+   :doc: IOCTL VM_OP
+
+.. kernel-doc:: include/uapi/drm/pvr_drm.h
+   :identifiers: drm_pvr_ioctl_vm_op_args
+
+.. kernel-doc:: include/uapi/drm/pvr_drm.h
+   :identifiers: drm_pvr_ioctl_vm_op_map_args drm_pvr_ioctl_vm_op_unmap_args
+
+.. kernel-doc:: include/uapi/drm/pvr_drm.h
+   :doc: Flags for VM_OP
+
+Internal notes
+==============
+.. kernel-doc:: include/gpu/drm/imagination/pvr_device.h
+   :doc: IOCTL validation helpers
+
+.. kernel-doc:: drivers/gpu/drm/imagination/pvr_device.h
+   :identifiers: PVR_STATIC_ASSERT_64BIT_ALIGNED PVR_IOCTL_UNION_PADDING_CHECK
+                 pvr_ioctl_union_padding_check
diff --git a/Documentation/gpu/imagination/virtual_memory.rst b/Documentation/gpu/imagination/virtual_memory.rst
new file mode 100644
index 000000000000..17c434055d03
--- /dev/null
+++ b/Documentation/gpu/imagination/virtual_memory.rst
@@ -0,0 +1,190 @@
+===========================
+GPU Virtual Memory Handling
+===========================
+The sources associated with this section can be found in ``pvr_vm.c`` and
+``pvr_vm.h``.
+
+.. kernel-doc:: drivers/gpu/drm/imagination/pvr_vm.c
+   :doc: PowerVR Virtual Memory Handling
+
+
+Public API
+==========
+.. kernel-doc:: drivers/gpu/drm/imagination/pvr_vm.h
+   :doc: Public API
+
+Types
+-----
+.. kernel-doc:: drivers/gpu/drm/imagination/pvr_vm.h
+   :identifiers: pvr_vm_page_options
+
+Functions
+---------
+.. kernel-doc:: drivers/gpu/drm/imagination/pvr_vm.c
+   :identifiers: pvr_vm_create_context pvr_vm_destroy_context
+                 pvr_vm_map pvr_vm_map_partial pvr_vm_unmap
+
+Helper functions
+----------------
+.. kernel-doc:: drivers/gpu/drm/imagination/pvr_vm.c
+   :identifiers: pvr_device_addr_is_valid
+
+Constants
+---------
+.. kernel-doc:: drivers/gpu/drm/imagination/pvr_vm.h
+   :doc: Public API (constants)
+
+
+VM backing pages
+================
+.. kernel-doc:: drivers/gpu/drm/imagination/pvr_vm.c
+   :doc: VM backing pages
+
+Types
+-----
+.. kernel-doc:: drivers/gpu/drm/imagination/pvr_vm.c
+   :identifiers: pvr_vm_backing_page
+
+Functions
+---------
+.. kernel-doc:: drivers/gpu/drm/imagination/pvr_vm.c
+   :identifiers: pvr_vm_backing_page_init pvr_vm_backing_page_fini
+                 pvr_vm_backing_page_sync
+
+Constants
+---------
+.. kernel-doc:: drivers/gpu/drm/imagination/pvr_vm.c
+   :doc: VM backing pages (constants)
+
+
+Raw page tables
+===============
+.. kernel-doc:: drivers/gpu/drm/imagination/pvr_vm.c
+   :doc: Raw page tables
+
+Types
+-----
+.. kernel-doc:: drivers/gpu/drm/imagination/pvr_vm.c
+   :identifiers: pvr_page_table_l2_entry_raw pvr_page_table_l1_entry_raw
+                 pvr_page_table_l0_entry_raw
+                 pvr_page_table_l2_raw pvr_page_table_l1_raw
+                 pvr_page_table_l0_raw
+
+Functions
+---------
+.. kernel-doc:: drivers/gpu/drm/imagination/pvr_vm.c
+   :identifiers: pvr_page_table_l2_entry_raw_is_valid
+                 pvr_page_table_l2_entry_raw_set
+                 pvr_page_table_l2_entry_raw_clear
+                 pvr_page_table_l1_entry_raw_is_valid
+                 pvr_page_table_l1_entry_raw_set
+                 pvr_page_table_l1_entry_raw_clear
+                 pvr_page_table_l0_entry_raw_is_valid
+                 pvr_page_table_l0_entry_raw_set
+                 pvr_page_table_l0_entry_raw_clear
+
+
+Mirror page tables
+==================
+.. kernel-doc:: drivers/gpu/drm/imagination/pvr_vm.c
+   :doc: Mirror page tables
+
+Types
+-----
+.. kernel-doc:: drivers/gpu/drm/imagination/pvr_vm.c
+   :identifiers: pvr_page_table_l2 pvr_page_table_l1 pvr_page_table_l0
+
+Functions
+---------
+.. kernel-doc:: drivers/gpu/drm/imagination/pvr_vm.c
+   :identifiers: pvr_page_table_l2_init pvr_page_table_l2_fini
+                 pvr_page_table_l2_sync pvr_page_table_l2_get_raw
+                 pvr_page_table_l2_get_entry_raw
+                 pvr_page_table_l2_insert pvr_page_table_l2_remove
+                 pvr_page_table_l1_init pvr_page_table_l1_fini
+                 pvr_page_table_l1_sync pvr_page_table_l1_get_raw
+                 pvr_page_table_l1_get_entry_raw
+                 pvr_page_table_l1_insert pvr_page_table_l1_remove
+                 pvr_page_table_l0_init pvr_page_table_l0_fini
+                 pvr_page_table_l0_sync pvr_page_table_l0_get_raw
+                 pvr_page_table_l0_get_entry_raw
+                 pvr_page_table_l0_insert pvr_page_table_l0_remove
+
+
+Page table index utilities
+==========================
+.. kernel-doc:: drivers/gpu/drm/imagination/pvr_vm.c
+   :doc: Page table index utilities
+
+Functions
+---------
+.. kernel-doc:: drivers/gpu/drm/imagination/pvr_vm.c
+   :identifiers: pvr_page_table_l2_idx pvr_page_table_l1_idx
+                 pvr_page_table_l0_idx
+
+Constants
+---------
+.. kernel-doc:: drivers/gpu/drm/imagination/pvr_vm.c
+   :doc: Page table index utilities (constants)
+
+
+High-level page table operations
+================================
+.. kernel-doc:: drivers/gpu/drm/imagination/pvr_vm.c
+   :doc: High-level page table operations
+
+Functions
+---------
+.. kernel-doc:: drivers/gpu/drm/imagination/pvr_vm.c
+   :identifiers: pvr_page_table_l1_create pvr_page_table_l1_get_or_create
+                 pvr_page_table_l0_create pvr_page_table_l0_get_or_create
+                 pvr_page_create pvr_page_destroy
+
+Internal functions
+------------------
+.. kernel-doc:: drivers/gpu/drm/imagination/pvr_vm.c
+   :identifiers: pvr_page_table_l1_create_unchecked __pvr_page_table_l1_destroy
+                 pvr_page_table_l0_create_unchecked __pvr_page_table_l0_destroy
+
+
+Page table pointer
+==================
+.. kernel-doc:: drivers/gpu/drm/imagination/pvr_vm.c
+   :doc: Page table pointer
+
+Types
+-----
+.. kernel-doc:: drivers/gpu/drm/imagination/pvr_vm.c
+   :identifiers: pvr_page_table_ptr
+
+Functions
+---------
+.. kernel-doc:: drivers/gpu/drm/imagination/pvr_vm.c
+   :identifiers: pvr_page_table_ptr_init pvr_page_table_ptr_fini
+                 pvr_page_table_ptr_next_page pvr_page_table_ptr_set
+                 pvr_page_table_ptr_require_sync pvr_page_table_ptr_copy
+                 pvr_page_table_ptr_sync pvr_page_table_ptr_sync_partial
+
+Internal functions
+------------------
+.. kernel-doc:: drivers/gpu/drm/imagination/pvr_vm.c
+   :identifiers: pvr_page_table_ptr_sync_manual pvr_page_table_ptr_load_tables
+
+
+Interval tree base implementation
+=================================
+.. kernel-doc:: drivers/gpu/drm/imagination/pvr_vm.c
+   :doc: Interval tree base implementation
+
+Types
+-----
+.. kernel-doc:: drivers/gpu/drm/imagination/pvr_vm.c
+   :identifiers: pvr_vm_interval_tree_node
+
+Functions
+---------
+.. kernel-doc:: drivers/gpu/drm/imagination/pvr_vm.c
+   :identifiers: pvr_vm_interval_tree_compute_last
+                 pvr_vm_interval_tree_node_start pvr_vm_interval_tree_node_size
+                 pvr_vm_interval_tree_node_last
+                 pvr_vm_interval_tree_insert
-- 
2.30.2

