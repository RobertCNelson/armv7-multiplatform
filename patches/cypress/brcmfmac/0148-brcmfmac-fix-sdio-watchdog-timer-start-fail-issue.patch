From 91d0d44dc49a7dcb20475b0f81689bff36179471 Mon Sep 17 00:00:00 2001
From: Ting-Ying Li <tingying.li@cypress.com>
Date: Fri, 26 Mar 2021 02:14:17 -0500
Subject: [PATCH 148/149] brcmfmac: fix sdio watchdog timer start fail issue

brcmf_sdio_wd_timer() started before F2 function enabling. In
such case, it will be returned because the sdiodev state is not
BRCMF_SDIOD_DATA. The first timer start will then fail. As a
fix, run brcmf_sdio_wd_timer() after F2 function enabling instead.

Signed-off-by: Ting-Ying Li <tingying.li@infineon.com>
Signed-off-by: Chi-hsien Lin <chi-hsien.lin@infineon.com>
---
 drivers/net/wireless/broadcom/brcm80211/brcmfmac/sdio.c | 8 ++++----
 1 file changed, 4 insertions(+), 4 deletions(-)

diff --git a/drivers/net/wireless/broadcom/brcm80211/brcmfmac/sdio.c b/drivers/net/wireless/broadcom/brcm80211/brcmfmac/sdio.c
index d85f1aa671e8..a0f28a4ff2ca 100644
--- a/drivers/net/wireless/broadcom/brcm80211/brcmfmac/sdio.c
+++ b/drivers/net/wireless/broadcom/brcm80211/brcmfmac/sdio.c
@@ -4414,10 +4414,6 @@ static void brcmf_sdio_firmware_callback(struct device *dev, int err,
 		goto fail;
 	bus->alp_only = false;
 
-	/* Start the watchdog timer */
-	bus->sdcnt.tickcnt = 0;
-	brcmf_sdio_wd_timer(bus, true);
-
 	sdio_claim_host(sdiod->func1);
 
 	/* Make sure backplane clock is on, needed to generate F2 interrupt */
@@ -4558,6 +4554,10 @@ static void brcmf_sdio_firmware_callback(struct device *dev, int err,
 
 	sdio_release_host(sdiod->func1);
 
+	/* Start the watchdog timer */
+	bus->sdcnt.tickcnt = 0;
+	brcmf_sdio_wd_timer(bus, true);
+
 	/* Assign bus interface call back */
 	sdiod->bus_if->dev = sdiod->dev;
 	sdiod->bus_if->ops = &brcmf_sdio_bus_ops;
-- 
2.17.1

